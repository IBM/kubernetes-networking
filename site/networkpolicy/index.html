
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <meta name="author" content="IBM Developer">
      
      
        <link rel="canonical" href="https://remkohdev.github.io/kubernetes-networking/networkpolicy/">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.2">
    
    
      
        <title>Network Policy and Calico - Kubernetes Networking</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.73f7c429.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
          
          
          <meta name="theme-color" content="#2094f3">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,400,400i,700%7CIBM+Plex+Mono&display=fallback">
        <style>body,input{font-family:"IBM Plex Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"IBM Plex Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#network-policy-and-calico" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://remkohdev.github.io/kubernetes-networking" title="Kubernetes Networking" class="md-header-nav__button md-logo" aria-label="Kubernetes Networking">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Kubernetes Networking
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Network Policy and Calico
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/remkohdev/kubernetes-networking/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    kubernetes-networking
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        Welcome
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../setup/" class="md-tabs__link md-tabs__link--active">
        Workshop
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../references/contributors/" class="md-tabs__link">
        References
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://remkohdev.github.io/kubernetes-networking" title="Kubernetes Networking" class="md-nav__button md-logo" aria-label="Kubernetes Networking">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Kubernetes Networking
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/remkohdev/kubernetes-networking/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    kubernetes-networking
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" >
    
    <label class="md-nav__link" for="nav-1">
      Welcome
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Welcome" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Welcome
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href=".." class="md-nav__link">
      About the workshop
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Workshop
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Workshop" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Workshop
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../setup/" class="md-nav__link">
      Setup
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../services/" class="md-nav__link">
      Services
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../clusterip/" class="md-nav__link">
      ClusterIP
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../nodeport/" class="md-nav__link">
      NodePort
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../loadbalancer/" class="md-nav__link">
      Loadbalancer and NLB
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../externalname/" class="md-nav__link">
      ExternalName
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../ingress-alb/" class="md-nav__link">
      Ingress and ALB
    </a>
  </li>

        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Network Policy and Calico
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Network Policy and Calico
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequirements" class="md-nav__link">
    Prerequirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-policy-and-calico_1" class="md-nav__link">
    Network Policy and Calico
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zero-trust-network-model" class="md-nav__link">
    Zero Trust Network Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-helloworld-proxy" class="md-nav__link">
    Create helloworld Proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply-network-policy-allow-no-traffic" class="md-nav__link">
    Apply Network Policy - Allow No Traffic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply-network-policy-allow-only-traffic-from-proxy" class="md-nav__link">
    Apply Network Policy - Allow Only Traffic From Proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../vpcgen2/" class="md-nav__link">
      VPC Gen2
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../airgap/" class="md-nav__link">
      Airgap
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" >
    
    <label class="md-nav__link" for="nav-3">
      References
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="References" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        References
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../references/contributors/" class="md-nav__link">
      Contributors
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequirements" class="md-nav__link">
    Prerequirements
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-policy-and-calico_1" class="md-nav__link">
    Network Policy and Calico
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zero-trust-network-model" class="md-nav__link">
    Zero Trust Network Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-helloworld-proxy" class="md-nav__link">
    Create helloworld Proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply-network-policy-allow-no-traffic" class="md-nav__link">
    Apply Network Policy - Allow No Traffic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#apply-network-policy-allow-only-traffic-from-proxy" class="md-nav__link">
    Apply Network Policy - Allow Only Traffic From Proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleanup" class="md-nav__link">
    Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/remkohdev/kubernetes-networking/edit/master/docs/networkpolicy.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="network-policy-and-calico">Network Policy and Calico<a class="headerlink" href="#network-policy-and-calico" title="Permanent link">&para;</a></h1>
<h2 id="prerequirements">Prerequirements<a class="headerlink" href="#prerequirements" title="Permanent link">&para;</a></h2>
<p>Finish the <a href="../services/">Services</a>, <a href="../clusterip/">ClusterIP</a>, <a href="../nodeport/">NodePort</a>, <a href="../loadbalancer/">LoadBalancer</a>, and <a href="../ingress-alb/">Ingress</a> labs,</p>
<ul>
<li>Guestbook Deployment</li>
<li>Guestbook Service of type LoadBalancer</li>
<li>Logged in to IBM Cloud account</li>
<li>Connected to Kubernetes cluster</li>
</ul>
<h2 id="network-policy-and-calico_1">Network Policy and Calico<a class="headerlink" href="#network-policy-and-calico_1" title="Permanent link">&para;</a></h2>
<p>To control traffic flow at the IP address or port level (OSI layer 3 or 4), you can use Kubernetes NetworkPolicies. Network policies are implemented by a Network Plugin. </p>
<p>When defining a pod- or namespace- based NetworkPolicy, labels are used to select pods and define rules which specify what traffic is allowed to the selected pods. For IP based NetworkPolicies, you define policies based on IP blocks (CIDR ranges).</p>
<p>By default, pods are non-isolated and accept traffic from any source. Once there is any NetworkPolicy in a namespace selecting a particular pod, that pod will be isolated and reject any connections not allowed by any NetworkPolicy. </p>
<p>Network policies do not conflict; they are additive. A pod is restricted to what is allowed by the union of policiesâ€™ ingress/egress rules. Thus, order of evaluation does not affect the policy result.</p>
<p>There are four kinds of selectors in an ingress <code>from</code> section or egress <code>to</code> section:</p>
<ul>
<li>podSelector,</li>
<li>namespaceSelector,</li>
<li>podSelector and namespaceSelector,</li>
<li>ipBlock for IP CIDR ranges.</li>
</ul>
<p>The following example allows traffic from a frontend application to a backend application,</p>
<div class="highlight"><pre><span></span><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: my-network-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: db
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          role: frontend
    ports:
    - protocol: TCP
      port: 6379
  egress:
  - to:
    - podSelector:
        matchLabels:
          role: backend
    ports:
    - protocol: TCP
      port: 5978
</code></pre></div>
<p>The following example denies all ingress traffic,</p>
<div class="highlight"><pre><span></span><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  podSelector: {}
  policyTypes:
  - Ingress
</code></pre></div>
<p>Every IBM Cloud Kubernetes Service cluster is set up with a network plug-in called Calico. Default network policies are set up to secure the public network interface of every worker node in the cluster. </p>
<p>You can use Kubernetes and Calico to create network policies for a cluster. With Kubernetes network policies, you can specify the network traffic that you want to allow or block to and from a pod within a cluster. To set more advanced network policies such as blocking inbound (ingress) traffic to a Network Load Balancer (NLB) services, use Calico network policies.</p>
<p>When a Kubernetes network policy is applied, it is automatically converted into a Calico network policy so that Calico can apply it as an Iptables rule. Both incoming and outgoing network traffic can be allowed or blocked based on protocol, port, and source or destination IP addresses. Traffic can also be filtered based on pod and namespace labels.</p>
<p>Calico network policies are a superset of the Kubernetes network policies and are applied by using calicoctl commands. Calico policies add the following features:
- Allow or block network traffic on specific network interfaces regardless of the Kubernetes pod source or destination IP address or CIDR.
- Allow or block network traffic for pods across namespaces.
- Block inbound traffic to Kubernetes LoadBalancer or NodePort services.</p>
<p>Calico enforces these policies, including any Kubernetes network policies that are automatically converted to Calico policies, by setting up Linux Iptables rules on the Kubernetes worker nodes. Iptables rules serve as a firewall for the worker node to define the characteristics that the network traffic must meet to be forwarded to the targeted resource.</p>
<p>Calico network policies and Calico global network policies are applied using calicoctl. Syntax is similar to Kubernetes, but there a few differences</p>
<h2 id="zero-trust-network-model">Zero Trust Network Model<a class="headerlink" href="#zero-trust-network-model" title="Permanent link">&para;</a></h2>
<p>Adopting a zero trust network model is best practice for securing workloads and hosts in your cloud-native strategy.</p>
<h2 id="create-helloworld-proxy">Create helloworld Proxy<a class="headerlink" href="#create-helloworld-proxy" title="Permanent link">&para;</a></h2>
<p>For this tutorial, we will use an additional app called <code>helloworld-proxy</code>, which proxies requests to the <code>helloworld</code> app. </p>
<p><img alt="helloworld proxy architecture" src="../images/helloworld-proxy.png" /></p>
<p>Deploy the <code>helloworld</code> proxy to the same namespace as the <code>helloworld</code> app,</p>
<div class="highlight"><pre><span></span><code>kubectl create -f helloworld-proxy-deployment.yaml -n $MY_NS
kubectl create -f helloworld-proxy-service-loadbalancer.yaml -n $MY_NS
</code></pre></div>
<p>The deployment in your project namespace should now look as follows,</p>
<div class="highlight"><pre><span></span><code>kubectl get all -n $MY_NS
NAME                                    READY   STATUS    RESTARTS   AGE
pod/helloworld-77bc887769-7n8wg         1/1     Running   0          27h
pod/helloworld-77bc887769-cts4v         1/1     Running   0          27h
pod/helloworld-77bc887769-w4tmc         1/1     Running   0          27h
pod/helloworld-proxy-5f689cf785-k7n6v   1/1     Running   0          15s
pod/helloworld-proxy-5f689cf785-qmmlz   1/1     Running   0          15s
pod/helloworld-proxy-5f689cf785-wh7x7   1/1     Running   0          15s

NAME                       TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)          AGE
service/helloworld         LoadBalancer   172.21.145.243   169.61.252.3   8080:30663/TCP   27h
service/helloworld-proxy   LoadBalancer   172.21.74.243    169.61.252.4   8080:30005/TCP   14s

NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/helloworld         3/3     3            3           27h
deployment.apps/helloworld-proxy   3/3     3            3           15s

NAME                                          DESIRED   CURRENT   READY   AGE
replicaset.apps/helloworld-77bc887769         3         3         3       27h
replicaset.apps/helloworld-proxy-5f689cf785   3         3         3       15s
</code></pre></div>
<p>Get the proxy service details and test the proxy,</p>
<div class="highlight"><pre><span></span><code>PROXY_HOST=$(kubectl get svc helloworld-proxy -n $MY_NS --output json | jq -r &#39;.status.loadBalancer.ingress[0].ip&#39;)
echo $PROXY_HOST

PROXY_NODEPORT=$(kubectl get svc helloworld-proxy -n $MY_NS --output json | jq -r &#39;.spec.ports[0].nodePort&#39;)
echo $PROXY_NODEPORT
</code></pre></div>
<p>Test the <code>helloworld-proxy</code> app, add the <code>host: helloworld:8080</code> property in the data object, which tells the <code>helloworld-proxy</code> app to proxy the message to the <code>host</code> app, and send the request to the <code>/proxy/api/messages</code> endpoint of our <code>helloworld-proxy</code> app,</p>
<div class="highlight"><pre><span></span><code>curl -L -X POST &quot;http://$PROXY_HOST:$PROXY_NODEPORT/proxy/api/messages&quot; -H &#39;Content-Type: application/json&#39; -H &#39;Content-Type: application/json&#39; -d &#39;{ &quot;sender&quot;: &quot;remko&quot;, &quot;host&quot;: &quot;helloworld:8080&quot; }&#39;

{&quot;id&quot;:&quot;6e5ef78f-9e09-42f8-8294-347ece7cd07f&quot;,&quot;sender&quot;:&quot;remko&quot;,&quot;message&quot;:&quot;Hello remko (proxy)&quot;,&quot;host&quot;:&quot;helloworld:8080&quot;}
</code></pre></div>
<h2 id="apply-network-policy-allow-no-traffic">Apply Network Policy - Allow No Traffic<a class="headerlink" href="#apply-network-policy-allow-no-traffic" title="Permanent link">&para;</a></h2>
<p>Define the Network Policy file to deny all traffic,</p>
<div class="highlight"><pre><span></span><code>echo &#39;apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: helloworld-deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress&#39; &gt; helloworld-policy-denyall.yaml
</code></pre></div>
<p>Create the Network Policy,</p>
<div class="highlight"><pre><span></span><code>kubectl create -f helloworld-policy-denyall.yaml -n $MY_NS

networkpolicy.networking.k8s.io/helloworld-deny-all created
</code></pre></div>
<p>Test both the <code>helloworld</code> and the <code>helloworld-proxy</code> apps,</p>
<div class="highlight"><pre><span></span><code>curl -L -X POST &quot;http://$PUBLIC_IP:$PORT/api/messages&quot; -H &#39;Content-Type: application/json&#39; -d &#39;{ &quot;sender&quot;: &quot;remko&quot; }&#39;

curl: (7) Failed to connect to 52.118.3.110 port 30663: Operation timed out

curl -L -X POST &quot;http://$PROXY_HOST:$PROXY_PORT/proxy/api/messages&quot; -H &#39;Content-Type: application/json&#39; -H &#39;Content-Type: application/json&#39; -d &#39;{ &quot;sender&quot;: &quot;remko&quot;, &quot;host&quot;: &quot;helloworld:8080&quot; }&#39;

curl: (7) Failed to connect to 169.61.252.4 port 80: Operation timed out
</code></pre></div>
<p>It takes quite a long time before connections time out. All traffic is denied, despite that we have a LoadBalancer service added to each deployment,</p>
<div class="highlight"><pre><span></span><code>kubectl get svc -n $MY_NS

NAME               TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)          AGE
helloworld         LoadBalancer   172.21.145.243   169.61.252.3   8080:30663/TCP   30h
helloworld-proxy   LoadBalancer   172.21.74.243    169.61.252.4   8080:30005/TCP   141m
</code></pre></div>
<h2 id="apply-network-policy-allow-only-traffic-from-proxy">Apply Network Policy - Allow Only Traffic From Proxy<a class="headerlink" href="#apply-network-policy-allow-only-traffic-from-proxy" title="Permanent link">&para;</a></h2>
<p>Let's allow direct ingress traffic to the <code>helloworld</code> app on port <code>8080</code>, but not allow traffic to the <code>helloworld-proxy</code> app. </p>
<p>Define the Network Policy file,</p>
<div class="highlight"><pre><span></span><code>echo &#39;apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: helloworld-allow
spec:
  selector: app == &#39;helloworld&#39;
  types:
  - Ingress
  ingress:
  - action: Allow
    protocol: TCP
    source:
      selector: role == &#39;helloworld-proxy&#39;
    destination: 
      ports:
      - 8080&#39; &gt; helloworld-calico-allow.yaml
</code></pre></div>
<p>Create the Network Policy,</p>
<div class="highlight"><pre><span></span><code>calicoctl create -f helloworld-calico-allow.yaml

Successfully created 1 &#39;GlobalNetworkPolicy&#39; resource(s)
</code></pre></div>
<p>Review the existing NetworkPolices in the project namespace,</p>
<div class="highlight"><pre><span></span><code>kubectl get networkpolicies -n $MY_NS
NAME                  POD-SELECTOR   AGE
helloworld-deny-all   &lt;none&gt;         3h10m
</code></pre></div>
<p>Review the existing GlobalNetworkPolicies,</p>
<div class="highlight"><pre><span></span><code>kubectl get globalnetworkpolicies

NAME                                AGE
default.allow-all-outbound          33h
default.allow-all-private-default   33h
default.allow-bigfix-port           33h
default.allow-icmp                  33h
default.allow-node-port-dnat        33h
default.allow-sys-mgmt              33h
default.allow-vrrp                  33h
default.helloworld-allow            14ms
</code></pre></div>
<p>Test the <code>helloworld</code> and the `helloworld-proxy' apps again,</p>
<div class="highlight"><pre><span></span><code>curl -L -X POST &quot;http://$PUBLIC_IP:$PORT/api/messages&quot; -H &#39;Content-Type: application/json&#39; -d &#39;{ &quot;sender&quot;: &quot;remko&quot; }&#39;

{&quot;id&quot;:&quot;19b0a0c0-ef05-4c91-8dd1-330e40d252ef&quot;,&quot;sender&quot;:&quot;remko&quot;,&quot;message&quot;:&quot;Hello remko (direct)&quot;,&quot;host&quot;:null}

curl -L -X POST &quot;http://$PROXY_HOST:$PROXY_PORT/proxy/api/messages&quot; -H &#39;Content-Type: application/json&#39; -H &#39;Content-Type: application/json&#39; -d &#39;{ &quot;sender&quot;: &quot;remko&quot;, &quot;host&quot;: &quot;helloworld:8080&quot; }&#39;

curl: (7) Failed to connect to 169.61.252.4 port 80: Operation timed out
</code></pre></div>
<h2 id="cleanup">Cleanup<a class="headerlink" href="#cleanup" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code>kubectl delete globalnetworkpolicy default.helloworld-allow
kubectl delete networkpolicy helloworld-deny-all
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../ingress-alb/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Ingress and ALB
              </div>
            </div>
          </a>
        
        
          <a href="../vpcgen2/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                VPC Gen2
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 IBM Developer
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/ibm" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/ibmdeveloper" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://www.linkedin.com/company/ibm/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://www.youtube.com/user/developerworks" target="_blank" rel="noopener" title="www.youtube.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://dev.to/ibmdeveloper" target="_blank" rel="noopener" title="dev.to" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M120.12 208.29c-3.88-2.9-7.77-4.35-11.65-4.35H91.03v104.47h17.45c3.88 0 7.77-1.45 11.65-4.35 3.88-2.9 5.82-7.25 5.82-13.06v-69.65c-.01-5.8-1.96-10.16-5.83-13.06zM404.1 32H43.9C19.7 32 .06 51.59 0 75.8v360.4C.06 460.41 19.7 480 43.9 480h360.2c24.21 0 43.84-19.59 43.9-43.8V75.8c-.06-24.21-19.7-43.8-43.9-43.8zM154.2 291.19c0 18.81-11.61 47.31-48.36 47.25h-46.4V172.98h47.38c35.44 0 47.36 28.46 47.37 47.28l.01 70.93zm100.68-88.66H201.6v38.42h32.57v29.57H201.6v38.41h53.29v29.57h-62.18c-11.16.29-20.44-8.53-20.72-19.69V193.7c-.27-11.15 8.56-20.41 19.71-20.69h63.19l-.01 29.52zm103.64 115.29c-13.2 30.75-36.85 24.63-47.44 0l-38.53-144.8h32.57l29.71 113.72 29.57-113.72h32.58l-38.46 144.8z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.08c56446.min.js"></script>
      <script src="../assets/javascripts/bundle.6ced434e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['navigation.tabs'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>